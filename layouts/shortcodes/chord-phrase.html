<script type = "text/javascript" src = "https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg-min.js"></script>
<style>
    :root{
        --palm: #ffb6b6ff;
    }
</style>
<h5>Click to load a pangram</h5>
<ul id="panagrams">
   <li >The quick brown fox jumps over the lazy dog.</li>
   <li >Waltz, bad nymph, for quick jigs vex.</li>
   <li >Sphinx of black quartz, judge my vow.</li>
   <li >var xyzOrds => (q){q % 2 || !^~ ? "c++"} </li>
</ul>
<form id="chordifyForm" action="javascript:chordify();">
    <textarea type="text" id="phrase" style="width: 100%"></textarea>
    <button id="chordify" type="submit">Chordify</button>
</form>
<details>
    <summary>Chord Syntax Legend</summary>
    <pre id="legend" class="bold">
        t = thumb
        i = index
        m = middle
        r = ring
        p = pinky

        mf = metacarpo-flexion
        pf = proximal-flexion
        me = metacarpo-extension
    </pre>
</details>
<div id="chord-area" class="row col-md-12">
    <div class="col-md-12" style="max-width: 100%">
        <h6>Chord strokes</h6>
        <pre id="chordified" class="bold" ></pre>
        <svg xmlns="http://www.w3.org/2000/svg" width="250" height="200" viewBox="0 0 50 50">
            <use id="handLegend" href="#hand" transform="scale(0.1,0.1)"/>
        </svg>
    </div>
    <div id="testAreaDiv" class="col-md-12" >
        <div style="width: 100%" class="row">
            <div id="test-timer" style="width: 75%; float: left;">Test: <span id="timer">0</span> sec</div>
            <button id="timerCancel" style="width: 20%; float: right;">X</button>
        </div>
        <div class="row">
            <textarea id="testArea" style="min-width: 80%" title="test chord"></textarea>
        </div>
    </div>
</div>
<script type="text/javascript">
    var testArea = document.getElementById('testArea');
    const lambdaUrl = 'https://l7c5uk7cutnfql5j4iunvx4fuq0yjfbs.lambda-url.us-east-1.on.aws/';
    var chordified = document.getElementById('chordified');
    var timer = document.getElementById('timer');
    var phrase = document.getElementById('phrase');
    var panagrams = document.getElementById('panagrams');

    var timerValue = 0;
    var timerHandle = null;

    var Timer = function(timerState) {

        this.stop = function() {
            if (timerObj) {
                clearInterval(timerObj);
                timerObj = null;
            }
            return this;
        }

        // start timer using current settings (if it's not already running)
        this.start = function() {
            if (!timerObj) {
                this.stop();
                timerObj = setInterval(fn, t);
            }
            return this;
        }

        // start with new or original interval, stop current interval
        this.reset = function(newT = t) {
            t = newT;
            return this.stop().start();
        }
    };
    var chordify = function() {
        chordified.innerHTML = '';
        var phrase = document.getElementById('phrase').value;
        if(phrase.trim().length == 0) {
            return;
        }
        console.log("phrase:", phrase);
        const phraseEncoded = btoa(phrase);
        console.log("phraseEncoded:", phraseEncoded);
        var chords = fetch(lambdaUrl, {
                method: 'POST',
                headers: {

                },
                body: JSON.stringify({
                    phrase: phraseEncoded
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(chordList) {
                if(chordList.error) {
                    console.log("chordList.error:", chordList.error);
                    return;
                }
                const chordRows = chordList.json;
                // Add each row to the chordified element as a separate div with the first character of the row as the name.
                chordRows.forEach(function(row, index) {
                    const rowDiv = document.createElement('div');
                    rowDiv.id = index;
                    rowDiv.setAttribute("name", row.char);
                    rowDiv.setAttribute("class", "outstanding");
                    const charSpan = document.createElement('span');
                    charSpan.innerHTML = row.char;
                    rowDiv.appendChild(charSpan);
                    rowDiv.appendChild(document.createTextNode(row.strokes));
                    chordified.appendChild(rowDiv);
                });
                setNext();
                testArea.focus();
            });
    };
    var resetHand = function() {
        document.querySelector("#thumb #me").setAttribute("fill", "#ffb6b6ff");
        document.querySelector("#thumb #mf").setAttribute("fill", "#ffb6b6ff");
        document.querySelector("#thumb #pf").setAttribute("fill", "#ffb6b6ff");
        document.querySelector("#index #me").setAttribute("fill", "#ffb6b6ff");
        document.querySelector("#index #mf").setAttribute("fill", "#ffb6b6ff");
        document.querySelector("#index #pf").setAttribute("fill", "#ffb6b6ff");
        document.querySelector("#middle #me").setAttribute("fill", "#ffb6b6ff");
        document.querySelector("#middle #mf").setAttribute("fill", "#ffb6b6ff");
        document.querySelector("#middle #pf").setAttribute("fill", "#ffb6b6ff");
        document.querySelector("#ring #me").setAttribute("fill", "#ffb6b6ff");
        document.querySelector("#ring #mf").setAttribute("fill", "#ffb6b6ff");
        document.querySelector("#ring #pf").setAttribute("fill", "#ffb6b6ff");
        document.querySelector("#pinky #me").setAttribute("fill", "#ffb6b6ff");
        document.querySelector("#pinky #mf").setAttribute("fill", "#ffb6b6ff");
        document.querySelector("#pinky #pf").setAttribute("fill", "#ffb6b6ff");
    };
    var setNext = () => {
        resetHand();
        const outstanding = chordified.getElementsByClassName('outstanding');
        if(outstanding.length == 0) {
            return;
        };
        var next = outstanding[0];
        next.setAttribute("class", "outstanding next");
        const strokes = next.innerHTML.split("</span>")[1].split(",");
        strokes.forEach((stroke, index)=>{
            stroke = stroke.trim();
            const strokeAction = stroke.slice(1,3);
            const rate = (Math.round(((index + 1) / strokes.length) * 16) - 1).toString(16);
            switch(stroke[0]) {
                case "t":
                    document.querySelector(`#thumb #${strokeAction}`).setAttribute("fill", `#0F0${rate}`);
                    break;
                case "i":
                    document.querySelector(`#index #${strokeAction}`).setAttribute("fill", `#0F0${rate}`);
                    break;
                case "m":
                    document.querySelector(`#middle #${strokeAction}`).setAttribute("fill", `#0F0${rate}`);
                    break;
                case "r":
                    document.querySelector(`#ring #${strokeAction}`).setAttribute("fill", `#0F0${rate}`);
                    break;
                case "p":
                    document.querySelector(`#pinky #${strokeAction}`).setAttribute("fill", `#0F0${rate}`);
                    break;
            }
        })
    }
    var testTimer = function(event) {
        // TODO: handle other than inputType == "insertText"
        if(event.inputType == "deleteContentBackward") {
            // TODO: handle backspace
            return;
        }
        if(testArea.value.trim().length == 0) {
            // stop timer
            clearInterval(timerHandle);
            timerHandle = null;
            timer.innerHTML = 0;
            timerValue = 0;
            return;
        }
        const curChar = chordified.getElementsByClassName('outstanding')[0];
        if(curChar && event.data == curChar.getAttribute("name").replace("Space", " ")){
            curChar.setAttribute("class", "completed");
        }
        setNext();
        if(testArea.value.trim() == phrase.value.trim()) {
            // stop timer
            clearInterval(timerHandle);
            timerHandle = null;
            return;
        }
        startTimer();
    };
    var runTimer = function() {
        timerValue++;
        timer.innerHTML = timerValue;
    };
    var resetChordifiedCompletion = function() {
        Array.from(chordified.getElementsByTagName('div')).forEach(function(element) {
            element.setAttribute("class", "outstanding");
        })
        setNext();
        testArea.focus();
    };
    var startTimer = function() {
        console.log("runTimer", timerValue);
        console.log("timerHandle:", timerHandle);
        if(!timerHandle) {
            timerHandle = setInterval(runTimer, 1000);
        }
    };
    
    document.getElementById('chordify')
        .addEventListener('click', chordify);
    phrase.addEventListener('change', chordify);
    testArea.addEventListener('input', testTimer);
    panagrams.addEventListener('click', function(e) {
        phrase.value = e.target.innerHTML;
        chordify();
    });
    document.getElementById('timerCancel')
        .addEventListener('click', function() {
            testArea.value = '';
            clearInterval(timerHandle);
            timerHandle = null;
            timer.innerHTML = 0;
            timerValue = 0;
            resetChordifiedCompletion();
    });
</script>
<svg id="chord-hand" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 500" fill="none"  xmlns:v="https://vecta.io/nano">
    <style>
        #thumb {
            fill: #ffb6b6ff;
        }
        #index {
            fill: #ffb6b6ff;
        }
        #middle {
            fill: #ffb6b6ff;
        }
        #ring {
            fill: #ffb6b6ff;
        }
        #pinky {
            fill: #ffb6b6ff;
        }
        <!-- #thumb #mf {
            fill: #00FF00FF;
        }  -->
    </style>
    <defs>
        <path id="h" d="M 0 0 L 600 0" stroke-width="1px" stroke="#AAA"/>
        <path id="v" d="M 0 0 L 0 600" stroke-width="1px" stroke="#AAA"/>
        <path id="phalange" 
            d="
                M 0 0 
                L 100 0
                L 100 100
                L 0 100
                Z" 
            stroke-width="2px" stroke="#000" />
        <path id="tip" 
            d="
                M 0 0 
                C 150 0, 150 100, 0 100
                L 0 100
                Z" 
            stroke-width="2px" stroke="#000" />
        <g id="hand">
            <g id="thumb"> 
                <use id="me" href="#phalange" transform="translate(0,0) scale(1,1) rotate(0)"/>
                <use id="mf" href="#phalange" transform="translate(100,0) scale(1,1) rotate(0)"/>
                <use id="pf" href="#tip" transform="translate(200,0) scale(1,1) rotate(0)"/>
            </g>
            <g id="index" transform="translate(0,100)"> 
                <use id="me" href="#phalange" transform="translate(0,0) scale(2,1) rotate(0)"/>
                <use id="mf" href="#phalange" transform="translate(200,0) scale(2,1) rotate(0)"/>
                <use id="pf" href="#tip" transform="translate(400,0) scale(1.5,1) rotate(0)"/>
            </g>
            <g id="middle" transform="translate(0,200)"> 
                <use id="me" href="#phalange" transform="translate(0,0) scale(2,1) rotate(0)"/>
                <use id="mf" href="#phalange" transform="translate(200,0) scale(2,1) rotate(0)"/>
                <use id="pf" href="#tip" transform="translate(400,0) scale(1.5,1) rotate(0)"/>
            </g>
            <g id="ring" transform="translate(0,300)"> 
                <use id="me" href="#phalange" transform="translate(0,0) scale(2,1) rotate(0)"/>
                <use id="mf" href="#phalange" transform="translate(200,0) scale(2,1) rotate(0)"/>
                <use id="pf" href="#tip" transform="translate(400,0) scale(1.5,1) rotate(0)"/>
            </g>
            <g id="pinky" transform="translate(0,400)"> 
                <use id="me" href="#phalange" transform="translate(0,0) scale(1.5,1) rotate(0)"/>
                <use id="mf" href="#phalange" transform="translate(150,0) scale(1.5,1) rotate(0)"/>
                <use id="pf" href="#tip" transform="translate(300,0) scale(1.5,1) rotate(0)"/>
            </g>
        </g>
    </defs>
</svg>