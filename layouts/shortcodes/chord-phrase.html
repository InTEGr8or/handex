<form id="chordifyForm" action="javascript:chordify();">
    </form><input type="text" id="phrase" />
    <button id="chordify" type="submit">Chordify</button>
</form>
<details>
    <summary>Chord Syntax Legend</summary>
    <pre id="legend" class="bold">t = thumb
    i = index
    m = middle
    r = ring
    p = pinky

    mf = metacarpo-flexion
    pf = proximal-flexion
    me = metacarpo-extension</pre>
</details>
<div id="chord-area" class="row col-md-12">
    <div class="col-md-6" style="max-width: 50%">
        <h6>Chord strokes</h6>
        <pre id="chordified" class="bold" ></pre>
    </div>
    <div class="col-md-6" style="max-width: 40%">
        <div class="row">
            <h6 id="test-timer" class="col-md-10">Test: <span id="timer">0</span> sec</h6>
            <button id="timerCancel" class="col-md-2">X</button>
        </div>
        <textarea id="testArea" style="min-width: 100%" title="test chord"></textarea>
    </div>
</div>
<script type="text/javascript">
    var testArea = document.getElementById('testArea');
    const lambdaUrl = 'https://r2swydpx7syeiycnrnny67bxii0myurm.lambda-url.us-east-1.on.aws/?phrase=';
    var chordified = document.getElementById('chordified');
    var timer = document.getElementById('timer');
    var phrase = document.getElementById('phrase');
    var timerValue = 0;
    var timerHandle = null;

    var Timer = function(timerState) {

        this.stop = function() {
            if (timerObj) {
                clearInterval(timerObj);
                timerObj = null;
            }
            return this;
        }

        // start timer using current settings (if it's not already running)
        this.start = function() {
            if (!timerObj) {
                this.stop();
                timerObj = setInterval(fn, t);
            }
            return this;
        }

        // start with new or original interval, stop current interval
        this.reset = function(newT = t) {
            t = newT;
            return this.stop().start();
        }
    };
    var chordify = function() {
        chordified.innerHTML = '';
        var phrase = document.getElementById('phrase').value;
        if(phrase.trim().length == 0) {
            return;
        }
        console.log("phrase:", phrase);
        const phraseEncoded = encodeURIComponent(btoa(phrase));
        console.log("phraseEncoded:", phraseEncoded);
        var chords = fetch(lambdaUrl + phraseEncoded)
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                chordified.innerHTML = data;
                return data;
            });
        for (var i = 0; i < chords.length; i++) {
        var chord = chords[i];
        var span = document.createElement('span');
        span.innerHTML = chord;
        chordified.appendChild(span);
        }
    };
    var testTimer = function() {
        if(testArea.value.trim().length == 0) {
            clearInterval(timerHandle);
            timerHandle = null;
            timer.innerHTML = 0;
            timerValue = 0;
            return;
        }
        if(testArea.value.trim() == phrase.value.trim()) {
            // stop timer
            clearInterval(timerHandle);
            timerHandle = null;
            return;
        }
        startTimer();
    };
    var runTimer = function() {
        timerValue++;
        timer.innerHTML = timerValue;
    };
    var startTimer = function() {
        console.log("runTimer", timerValue);
        console.log("timerHandle:", timerHandle);
        if(!timerHandle) {
            timerHandle = setInterval(runTimer, 1000);
        }
    };
    // TODO: check testArea to see if it contains each of the characters listed in the first column of chordified.
    // If it does, then highlight the character in the chordified.
    
    document.getElementById('chordify')
        .addEventListener('click', chordify);
    phrase.addEventListener('input', chordify);
    testArea.addEventListener('input', testTimer);
    document.getElementById('timerCancel')
        .addEventListener('click', function() {
            testArea.value = '';
            clearInterval(timerHandle);
            timerHandle = null;
            timer.innerHTML = 0;
            timerValue = 0;
    });
</script>